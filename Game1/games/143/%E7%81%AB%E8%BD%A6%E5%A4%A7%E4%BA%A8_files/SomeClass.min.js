var Constant = {};
Constant.blockSize = 74;
Constant.windowW = 860;
Constant.windowH = 480;
Constant.gameW = 720;
Constant.gameH = 450;
Constant.WHScale = Constant.gameW / Constant.gameH;
Constant.WHScale268 = 480 / 268;
Constant.gameMapW = 54;
Constant.gameMapH = 80;
Constant.gameMapLeftInGame = 27;
Constant.gameMapTopInGame = 31;
Constant.gameMapBottomInGame = 54;
Constant.gameLeft = (Constant.windowW - Constant.gameW) / 2;
Constant.gameTop = (Constant.windowH - Constant.gameH) / 2;
var bgMusic = document.createElement("audio");
bgMusic.setAttribute("src", "sound/bgMusic.mp3");
bgMusic.setAttribute("loop", true);
var Train = function (f, a, d, c) {
	this.scale = f;
	this.initY = this.initX = 0;
	this.trainImgW = 60;
	this.trainImgH = 34;
	this.width = Math.round(56 * this.scale);
	this.width1 = Math.round(68 * this.scale);
	this.height = c ? Math.round(c * this.scale) : Math.round(34 * this.scale);
	this.halfW = Math.round(this.width / 2);
	this.halfH = Math.round(this.height / 2);
	this.outDirection = this.fromDirection = 0;
	this.speed = Math.round(this.scale * d);
	this.turnSpeedSetDelay = 0;
	this.anglePi = Math.PI * 150;
	this.angle = 0;
	this.r = a / 2;
	this.blockFps = Math.round(a / this.speed);
	this.tranAngle = 50 / this.blockFps;
	this.tranIndex = 1;
	this.trainInIndex = -1;
	this.tranTurnSpeed = Math.round(this.r / 2 * 3 / this.blockFps);
	this.startTrainSpaceTime1 = Math.round((this.width1 + this.width) / 2 / this.speed);
	this.startTrainSpaceTime = Math.round(this.width / this.speed);
	this.drawIndex = 0;
	this.showIndex = Math.round(28 * this.scale / this.speed - 1);
	this.isBoss = false;
	this.getfromDirection = function (b, e) {
		var g = 0;
		if (b < e)
			g = b + 1 == e ? 1 : 2;
		else if (b > e)
			g = b - 1 == e ? 3 : 4;
		return g
	};
	this.getCanRunIn = function (b) {
		switch (b) {
		case 1:
			return [[1,
					1], [1, 3], [2, 1], [2, 4], [2, 5], [2, 6], [4, 1], [6, 3]];
		case 2:
			return [[1, 2], [1, 3], [2, 1], [2, 2], [2, 5], [2, 6], [4, 2], [6, 4]];
		case 3:
			return [[1, 1], [1, 3], [2, 2], [2, 3], [2, 5], [2, 6], [4, 3], [6, 3]];
		case 4:
			return [[1, 2], [1, 3], [2, 3], [2, 4], [2, 5], [2, 6], [4, 4], [6, 4]]
		}
	};
	this.checkCanRunIn = function (b, e, g) {
		runInArr = this.getCanRunIn(b);
		b = 0;
		for (var h = runInArr.length; b < h; b++)
			if (e == runInArr[b][0] && g == runInArr[b][1])
				return true;
		return false
	};
	this.setTrainMoveXY = function () {
		var b = this.outDirection,
		e = this.fromDirection,
		g = this.speed;
		if (e == 1 &&
			b == 3)
			this.initX += g;
		else if (e == 3 && b == 1)
			this.initX -= g;
		else if (e == 2 && b == 4)
			this.initY += g;
		else if (e == 4 && b == 2)
			this.initY -= g;
		else if (e == 1 && b == 2) {
			if (this.tranIndex <= this.blockFps / 3 - this.turnSpeedSetDelay)
				this.initX += this.tranTurnSpeed;
			else {
				if (this.tranIndex <= 2 * this.blockFps / 3)
					this.initX += this.tranTurnSpeed;
				this.initY -= this.tranTurnSpeed
			}
			this.angle -= this.tranAngle
		} else if (e == 2 && b == 1) {
			if (this.tranIndex <= this.blockFps / 3 - this.turnSpeedSetDelay)
				this.initY += this.tranTurnSpeed;
			else if (this.tranIndex <= 2 * this.blockFps /
				3) {
				this.initX -= this.tranTurnSpeed;
				this.initY += this.tranTurnSpeed
			} else
				this.initX -= this.tranTurnSpeed;
			this.angle += this.tranAngle
		} else if (e == 2 && b == 3) {
			if (this.tranIndex <= this.blockFps / 3 - this.turnSpeedSetDelay)
				this.initY += this.tranTurnSpeed;
			else if (this.tranIndex <= 2 * this.blockFps / 3) {
				this.initX += this.tranTurnSpeed;
				this.initY += this.tranTurnSpeed
			} else
				this.initX += this.tranTurnSpeed;
			this.angle -= this.tranAngle
		} else if (e == 3 && b == 2) {
			if (this.tranIndex <= this.blockFps / 3 - this.turnSpeedSetDelay)
				this.initX -= this.tranTurnSpeed;
			else {
				if (this.tranIndex <= 2 * this.blockFps / 3)
					this.initX -= this.tranTurnSpeed;
				this.initY -= this.tranTurnSpeed
			}
			this.angle += this.tranAngle
		} else if (e == 3 && b == 4) {
			if (this.tranIndex <= this.blockFps / 3 - this.turnSpeedSetDelay)
				this.initX -= this.tranTurnSpeed;
			else {
				if (this.tranIndex <= 2 * this.blockFps / 3)
					this.initX -= this.tranTurnSpeed;
				this.initY += this.tranTurnSpeed
			}
			this.angle -= this.tranAngle
		} else if (e == 4 && b == 3) {
			if (this.tranIndex <= this.blockFps / 3 - this.turnSpeedSetDelay)
				this.initY -= this.tranTurnSpeed;
			else if (this.tranIndex <=
				2 * this.blockFps / 3) {
				this.initX += this.tranTurnSpeed;
				this.initY -= this.tranTurnSpeed
			} else
				this.initX += this.tranTurnSpeed;
			this.angle += this.tranAngle
		} else if (e == 1 && b == 4) {
			if (this.tranIndex <= this.blockFps / 3 - this.turnSpeedSetDelay)
				this.initX += this.tranTurnSpeed;
			else {
				if (this.tranIndex <= 2 * this.blockFps / 3)
					this.initX += this.tranTurnSpeed;
				this.initY += this.tranTurnSpeed
			}
			this.angle += this.tranAngle
		} else if (e == 4 && b == 1) {
			if (this.tranIndex <= this.blockFps / 3 - this.turnSpeedSetDelay)
				this.initY -= this.tranTurnSpeed;
			else if (this.tranIndex <=
				2 * this.blockFps / 3) {
				this.initX -= this.tranTurnSpeed;
				this.initY -= this.tranTurnSpeed
			} else
				this.initX -= this.tranTurnSpeed;
			this.angle -= this.tranAngle
		}
		this.tranIndex++;
		this.drawX = this.initX - this.halfW;
		this.drawY = this.initY - this.halfH
	};
	this.getExitDirection = function (b, e, g) {
		if (e == 1 && g == 1)
			return b == 1 ? 3 : 1;
		else if (e == 1 && g == 2)
			return b == 2 ? 4 : 2;
		else if (e == 1 && g == 3)
			if (b == 1)
				return 3;
			else if (b == 3)
				return 1;
			else if (b == 2)
				return 4;
			else {
				if (b == 4)
					return 2
			}
		else if (e == 2 && g == 1)
			return b == 1 ? 2 : 1;
		else if (e == 2 && g == 2)
			return b == 2 ? 3 :
			2;
		else if (e == 2 && g == 3)
			return b == 3 ? 4 : 3;
		else if (e == 2 && g == 4)
			return b == 4 ? 1 : 4;
		else if (e == 2 && g == 5)
			if (b == 1)
				return 2;
			else if (b == 2)
				return 1;
			else if (b == 3)
				return 4;
			else {
				if (b == 4)
					return 3
			}
		else if (e == 2 && g == 6)
			if (b == 2)
				return 3;
			else if (b == 3)
				return 2;
			else if (b == 1)
				return 4;
			else {
				if (b == 4)
					return 1
			}
		else if (e == 6 && g == 3)
			if (b == 1)
				return 3;
			else {
				if (b == 3)
					return 1
			}
		else if (e == 6 && g == 4)
			if (b == 2)
				return 4;
			else if (b == 4)
				return 2
	};
	this.setSpeed = function (b) {
		this.turnSpeedSetDelay = b < 300 ? 0 : 1
	}
}, Blocks = [];
(function () {
	for (var f = 1, a = 0; a < 63; a++) {
		var d = (a + 21) % 21 * Constant.blockSize,
		c = Math.floor(a / 21) * Constant.blockSize,
		b = function () {
			this.angle = 0;
			this.out = this.from = -1;
			this.hasBoss = this.hasTran = false;
			this.traning = true
		};
		b.prototype.getTranTargetFinal = function () {
			var e = null;
			if (this.bid >= 25 && this.bid <= 40)
				switch (this.bid) {
				case 25:
					e = 9;
					break;
				case 26:
					e = 17;
					break;
				case 27:
					e = 10;
					break;
				case 28:
					e = 18;
					break;
				case 29:
					e = 11;
					break;
				case 30:
					e = 19;
					break;
				case 31:
					e = 12;
					break;
				case 32:
					e = 20;
					break;
				case 33:
					e = 13;
					break;
				case 34:
					e = 21;
					break;
				case 35:
					e =
						14;
					break;
				case 36:
					e = 22;
					break;
				case 37:
					e = 15;
					break;
				case 38:
					e = 23;
					break;
				case 39:
					e = 16;
					break;
				case 40:
					e = 24
				}
			else if (this.bid == 60) {
				if (this.type2 == 1)
					e = 5;
				if (this.type2 == 2)
					e = 4;
				if (this.type2 == 3)
					e = 2;
				if (this.type2 == 4)
					e = 3
			} else if (this.bid == 61) {
				if (this.type2 == 5)
					e = 7;
				if (this.type2 == 6)
					e = 6
			} else if (this.bid == 62) {
				if (this.type2 == 1)
					e = 0;
				if (this.type2 == 2)
					e = 1
			} else
				e = -1;
			return e
		};
		b.prototype.bid = a;
		b.prototype.x = d;
		b.prototype.y = c;
		b.prototype.isTranslate = 25 <= a && a <= 40 || 60 <= a && a <= 62 ? true : false;
		if (25 <= a && a <= 40) {
			b.prototype.tranTarget =
				a + f;
			f = -f
		}
		if (a == 0 || a >= 21 && a <= 24 || a == 34 || a == 36 || a == 38 || a == 40 || a == 62) {
			b.prototype.type1 = 1;
			b.prototype.type2 = 1
		}
		if (a == 1 || a >= 17 && a <= 20 || a == 26 || a == 28 || a == 30 || a == 32) {
			b.prototype.type1 = 1;
			b.prototype.type2 = 2
		}
		if (a == 8) {
			b.prototype.type1 = 1;
			b.prototype.type2 = 3
		}
		if (a == 5 || a == 12 || a == 14 || a == 31 || a == 35 || a == 60) {
			b.prototype.type1 = 2;
			b.prototype.type2 = 1
		}
		if (a == 4 || a == 11 || a == 13 || a == 29 || a == 33) {
			b.prototype.type1 = 2;
			b.prototype.type2 = 2
		}
		if (a == 2 || a == 9 || a == 15 || a == 25 || a == 37) {
			b.prototype.type1 = 2;
			b.prototype.type2 = 3
		}
		if (a == 3 || a == 10 || a ==
			16 || a == 27 || a == 39) {
			b.prototype.type1 = 2;
			b.prototype.type2 = 4
		}
		if (a == 7 || a == 61) {
			b.prototype.type1 = 2;
			b.prototype.type2 = 5
		}
		if (a == 6) {
			b.prototype.type1 = 2;
			b.prototype.type2 = 6
		}
		if (a == 42) {
			b.prototype.type1 = 6;
			b.prototype.type2 = 3
		}
		if (a == 43) {
			b.prototype.type1 = 6;
			b.prototype.type2 = 4
		}
		if (a == 44) {
			b.prototype.type1 = 3;
			b.prototype.type2 = 1
		}
		if (a == 46) {
			b.prototype.type1 = 3;
			b.prototype.type2 = 2
		}
		if (a == 45) {
			b.prototype.type1 = 3;
			b.prototype.type2 = 3
		}
		if (a == 47) {
			b.prototype.type1 = 3;
			b.prototype.type2 = 4
		}
		if (a == 48) {
			b.prototype.type1 = 4;
			b.prototype.type2 =
				1
		}
		if (a == 50) {
			b.prototype.type1 = 4;
			b.prototype.type2 = 2
		}
		if (a == 49) {
			b.prototype.type1 = 4;
			b.prototype.type2 = 3
		}
		if (a == 51) {
			b.prototype.type1 = 4;
			b.prototype.type2 = 4
		}
		if (a >= 52 && a <= 59) {
			b.prototype.type1 = 5;
			b.prototype.type2 = 1
		}
		Blocks.push(b)
	}
})();
var TrainSmoke = function (f) {
	this.imgX = f.imgX;
	this.imgY = f.imgY;
	this.width = f.width;
	this.height = f.height
}, Smoke = [];
(function () {
	for (var f = 0; f < 3; f++) {
		var a = new TrainSmoke({
				imgX : 31 * f,
				imgY : 0,
				width : 31,
				height : 16
			});
		Smoke.push(a)
	}
})();
var MapLevels = {};
MapLevels.getLevel = function (f) {
	switch (f) {
	case 1:
		return [60, 53, 60, 60, 57, 60, 60, 52, 57, 46, 1, 1, 4, 60, 60, 60, 2, 60, 60, 60, 60, 63, 60, 60, 61, 15, 60, 60, 57, 60, 2, 60, 60, 2, 60, 57, 57, 60, 1, 62, 1, 1, 6, 60, 60];
	case 2:
		return [60, 60, 57, 3, 1, 1, 61, 1, 4, 60, 57, 60, 2, 53, 60, 2, 60, 51, 46, 1, 1, 61, 60, 60, 63, 60, 60, 57, 60, 60, 2, 60, 60, 2, 53, 60, 60, 57, 1, 35, 1, 1, 37, 60, 57];
	case 3:
		return [56, 50, 1, 38, 1, 1, 1, 61, 56, 56, 56, 60, 2, 56, 56, 2, 2, 60, 60, 60, 1, 27, 1, 1, 36, 6, 56, 56, 58, 60, 2, 60, 60, 56, 56, 56, 56, 56, 1, 61, 1, 1, 1, 1, 45];
	case 4:
		return [3, 4, 3, 1, 1, 1, 62, 55, 56, 2, 30, 63, 4, 56, 58,
			2, 60, 56, 47, 2, 2, 2, 60, 56, 2, 56, 56, 60, 2, 51, 9, 56, 60, 2, 60, 60, 56, 5, 1, 36, 1, 1, 13, 55, 55];
	case 5:
		return [55, 56, 56, 60, 48, 60, 56, 56, 56, 3, 1, 4, 56, 2, 60, 58, 56, 56, 2, 60, 2, 3, 62, 16, 1, 1, 4, 2, 60, 61, 9, 1, 9, 1, 49, 44, 35, 1, 1, 62, 1, 14, 1, 1, 6];
	case 6:
		return [3, 1, 1, 24, 1, 1, 1, 4, 54, 9, 55, 50, 9, 1, 1, 62, 62, 4, 2, 58, 60, 2, 56, 4, 5, 1, 33, 2, 60, 55, 27, 1, 62, 1, 1, 6, 5, 1, 1, 6, 54, 47, 56, 56, 56];
	case 7:
		return [60, 62, 60, 55, 60, 3, 29, 59, 54, 48, 50, 25, 25, 25, 62, 35, 23, 62, 2, 3, 4, 3, 4, 3, 28, 3, 28, 2, 27, 34, 34, 34, 34, 34, 34, 36, 5, 61, 60, 56, 60, 60, 56, 60, 56];
	case 8:
		return [3, 62, 1, 1, 1, 39, 29,
			59, 60, 2, 47, 3, 1, 38, 62, 9, 4, 55, 2, 55, 51, 55, 3, 9, 37, 11, 60, 2, 59, 55, 60, 30, 9, 40, 6, 55, 5, 1, 1, 1, 6, 5, 6, 55, 60];
	case 9:
		return [56, 3, 4, 3, 1, 4, 3, 4, 56, 3, 9, 9, 62, 56, 8, 9, 9, 4, 5, 62, 11, 9, 56, 9, 20, 62, 6, 3, 37, 13, 63, 58, 63, 12, 62, 4, 5, 45, 56, 5, 1, 6, 56, 51, 6];
	case 10:
		return [56, 60, 56, 58, 60, 46, 1, 29, 56, 3, 49, 60, 56, 56, 60, 56, 2, 60, 2, 3, 1, 43, 1, 1, 4, 2, 56, 62, 9, 1, 1, 1, 1, 9, 37, 60, 56, 5, 1, 1, 1, 1, 6, 60, 56];
	case 11:
		return [56, 62, 62, 8, 7, 62, 54, 58, 60, 52, 62, 62, 9, 7, 62, 54, 60, 54, 62, 8, 62, 8, 61, 8, 62, 56, 60, 62, 62, 7, 9, 7, 8, 62, 34, 45, 56, 62, 7, 8, 56, 56, 2, 56, 56];
	case 12:
		return [59,
			9, 38, 9, 62, 4, 62, 62, 54, 3, 62, 29, 53, 20, 7, 8, 9, 58, 62, 61, 47, 54, 30, 11, 52, 5, 61, 63, 9, 17, 1, 19, 14, 9, 39, 32, 31, 9, 34, 1, 62, 14, 62, 15, 59];
	case 13:
		return [48, 9, 62, 9, 62, 9, 62, 9, 62, 9, 62, 9, 62, 9, 62, 9, 62, 9, 62, 9, 62, 9, 62, 9, 62, 9, 62, 9, 62, 9, 62, 9, 62, 9, 62, 52, 62, 9, 62, 9, 62, 9, 62, 9, 62];
	case 14:
		return [60, 3, 62, 17, 4, 3, 4, 62, 4, 3, 62, 9, 62, 10, 62, 62, 62, 32, 5, 62, 9, 62, 9, 62, 33, 9, 33, 3, 62, 9, 62, 62, 62, 62, 9, 33, 5, 6, 47, 50, 34, 9, 15, 9, 62];
	case 15:
		return [46, 40, 62, 62, 62, 9, 62, 62, 56, 56, 62, 9, 62, 63, 1, 62, 62, 60, 3, 9, 9, 62, 62, 1, 62, 61, 56, 62, 62, 62, 62, 36, 1, 34, 49, 60, 5, 62,
			62, 62, 62, 56, 58, 60, 56];
	case 16:
		return [60, 27, 17, 48, 60, 3, 4, 55, 60, 59, 27, 14, 33, 62, 62, 63, 60, 55, 62, 32, 9, 62, 9, 62, 7, 41, 60, 62, 11, 9, 62, 62, 61, 63, 37, 60, 62, 62, 22, 61, 54, 51, 60, 56, 60];
	case 17:
		return [48, 62, 62, 62, 62, 62, 62, 62, 62, 61, 9, 9, 9, 9, 9, 9, 9, 62, 62, 9, 9, 9, 62, 9, 9, 9, 62, 62, 9, 9, 9, 9, 9, 9, 9, 61, 62, 62, 62, 62, 62, 62, 62, 62, 51];
	case 18:
		return [50, 4, 56, 55, 56, 56, 3, 4, 56, 3, 9, 61, 62, 63, 62, 63, 9, 4, 5, 7, 63, 63, 62, 63, 63, 9, 6, 55, 5, 61, 62, 62, 62, 63, 28, 55, 56, 55, 5, 6, 56, 5, 6, 47, 56];
	case 19:
		return [48, 52, 58, 3, 39, 1, 1, 1, 62, 30, 9, 34, 34, 9, 9, 38, 62, 29, 9, 31, 24,
			25, 33, 62, 6, 62, 29, 27, 38, 22, 34, 62, 62, 23, 17, 63, 5, 8, 55, 55, 7, 8, 56, 14, 15];
	case 20:
		return [3, 62, 62, 38, 62, 40, 61, 17, 4, 61, 9, 9, 9, 9, 9, 36, 35, 29, 5, 9, 62, 9, 62, 9, 61, 49, 28, 3, 9, 62, 2, 9, 5, 6, 61, 61, 5, 33, 1, 35, 34, 1, 1, 35, 45];
	case 21:
		return [46, 4, 3, 40, 40, 16, 1, 4, 57, 3, 9, 9, 9, 9, 9, 4, 2, 53, 44, 63, 63, 63, 63, 63, 2, 2, 57, 5, 9, 9, 9, 9, 9, 6, 2, 53, 57, 5, 6, 5, 34, 36, 57, 5, 49];
	default:
		return null
	}
};
var RM = function () {
	this.level = -1;
	this.levelMapCache = [];
	this.blockSize = this.initBlockSize = Constant.blockSize;
	this.portrait = false;
	this.scale = 1;
	this.gameWinTop = this.gameWinLeft = this.left = this.top = 0;
	this.ctx = jsGame.canvas.getContext();
	this.isTranslate = false;
	this.delta = this.initDelta = 0.18;
	this.tranIndex = 0;
	this.tranIndexMax = 4;
	this.halfTranIndexMax = this.tranIndexMax / 2;
	this.tranAngle = 12.5;
	this.touchBlockIndex = -1;
	this.touchY = this.touchX = 0;
	this.readyTran = false;
	this.sc = 1;
	this.tranType = 0;
	this.blanBlock = new Blocks[59];
	this.anglePi = Math.PI * 150;
	this.isRun = false;
	this.trains = [];
	this.halfBlockSize = Math.floor(this.blockSize / 2);
	this.levelMap = [];
	this.smokeDrawH = this.smokeDrawW = this.smoke = this.somkeLoopIndex = this.somkeIndex = this.drawTrainIndex = 0;
	this.cacheCanvas = document.createElement("canvas");
	this.cacheCanvasCtx = this.cacheCanvas.getContext("2d");
	this.cacheChooseCanvas = document.createElement("canvas");
	this.cacheChooseCanvasCtx = this.cacheChooseCanvas.getContext("2d");
	this.gameType = "welcome";
	this.buttonAnimateIndex = 0;
	this.pressButton =
		false;
	this.winLevels = [];
	this.winLevels.push(false);
	this.winLevels.push(true);
	for (var f = 1; f < 25; f++)
		this.winLevels.push(false);
	this.iphoneCut = this.btnTmpIndex = 0;
	this.levelUpScore = [];
	for (f = 0; f <= 25; f++)
		this.levelUpScore.push([0]);
	this.playing = false;
	this.gameSecond = 0;
	_self = this;
	this.gameTime = setInterval(function () {
			_self.setTime()
		}, 1E3);
	this.screenOk = true;
	this.setTime = function () {
		this.playing && this.screenOk && this.gameSecond++
	};
	this.gameTypeHelpIndex = 0;
	this.isNew = false;
	this.maxScore = 0;
	this.scoreScale = 1;
	this.score =
		this.thisLevelScore = 0;
	this.welcomePoint = 1;
	this.welcomeIndex = 0;
	this.hasBoss = false;
	this.bossTrains = [];
	this.bossTrainInBlockIndex = -1;
	this.drawBossTrainIndex = 1;
	this.winIndex = 0;
	jsGame.localStorage.init();
	this.bgMusicType = "play";
	this.bgMusicPicY = 60;
	this.init = function (a, d, c) {
		this.winW = a;
		this.winH = d;
		this.scale = c;
		if (jsGame.canvas.screen.getTouch())
			if (this.winH == 208)
				this.winH = 268;
		if (this.winW < 720 || this.winH < 450) {
			if (this.winH == 268)
				this.iphoneCut = 48;
			this.portrait = false;
			this.blockSize = Math.floor(Constant.blockSize *
					this.scale);
			this.halfBlockSize = Math.floor(this.blockSize / 2);
			this.left = Math.round((this.winW - this.blockSize * 9) / 2);
			this.top = Math.round(Constant.gameMapTopInGame * this.scale)
		} else {
			this.winW = 720;
			this.winH = 450;
			this.left = Constant.gameMapLeftInGame;
			this.top = Constant.gameMapTopInGame
		}
		this.backBtnY = Math.round(this.blockSize * 3.8);
		this.startBtnY = Math.round(this.blockSize * 3.8);
		a = jsGame.localStorage.getItem("maxLevel");
		for (d = 1; d <= a; d++)
			this.winLevels[d] = true;
		jsGame.touch.init(false);
		this.showTip = this.winH == 300 ?
			false : true
	};
	this.initLevelMap = function () {
		this.cacheCanvas.width = this.winW;
		this.cacheCanvas.height = this.winH;
		this.cacheCanvasCtx.drawImage(jsGame.getImage("bg"), 0, 0, 720, 450 - this.iphoneCut, 0, 0, this.winW, this.winH);
		this.levelMap.length = [];
		for (var a = 0; a < 45; a++) {
			var d = new(Blocks[MapLevels.getLevel(this.level)[a] - 1]);
			if (d.bid == 42 || d.bid == 43) {
				this.hasBoss = true;
				this.bossTrainInBlockIndex = a;
				this.bossTrains = [];
				this.drawBossTrainIndex = 1
			}
			this.levelMap.push(d);
			if (60 <= d.bid && d.bid <= 62 || 25 <= d.bid && d.bid <= 40)
				d =
					this.blanBlock;
			var c = (a + 9) % 9 * this.blockSize + this.left,
			b = Math.floor(a / 9) * this.blockSize + this.top;
			this.cacheCanvasCtx.drawImage(jsGame.getImage("mapBlocks"), d.x, d.y, Constant.blockSize, Constant.blockSize, c, b, this.blockSize, this.blockSize)
		}
		this.cacheCanvasCtx.drawImage(jsGame.getImage("ui1"), 0, 0, 30, 30, this.winW - this.left * 2, 0, Math.round(30 * this.scale), Math.round(30 * this.scale));
		this.score = 0;
		for (a = 1; a < 25; a++) {
			d = jsGame.localStorage.getItem(a + "_maxScore");
			if (d > 0)
				this.score += parseInt(d)
		}
	};
	this.initChoose =
	function () {
		this.cacheChooseCanvas.width = this.winW;
		this.cacheChooseCanvas.height = this.winH;
		this.cacheChooseCanvasCtx.drawImage(jsGame.getImage("choose"), 0, 0, 720, 450 - this.iphoneCut, 0, 0, this.winW, this.winH);
		for (var a = 0; a < 21; a++) {
			var d = (a % 7 + 1) * this.blockSize + this.left,
			c = (Math.floor(a / 7) + 1) * this.blockSize + this.top;
			this.cacheChooseCanvasCtx.drawImage(jsGame.getImage("chooseBtn"), 0, 0, 71, 71, d, c, Math.round(71 * this.scale * 0.8), Math.round(71 * this.scale * 0.8))
		}
	};
	this.initTranBlock = function () {
		this.isTranslate = this.readyTran =
			false;
		this.tranIndex = 0;
		this.sc = 1;
		this.touchBlockIndex = -1;
		this.tranType = 0;
		this.delta = this.initDelta
	};
	this.initGameArgs = function () {
		this.buttonAnimateIndex = 0;
		this.pressButton = false;
		this.touchBlockIndex = -1
	};
	this.drawGame = function () {
		jsGame.canvas.clearScreen();
		if (this.gameType == "welcome") {
			this.welcomeIndex++;
			if (this.welcomeIndex >= Math.round(30 * this.scale)) {
				this.welcomePoint = -this.welcomePoint;
				this.welcomeIndex = -Math.round(30 * this.scale)
			}
			this.backBtnY += this.welcomePoint;
			this.startBtnY -= this.welcomePoint;
			jsGame.canvas.drawImage("welcome", 67, 0, 720, 450 - this.iphoneCut, 0, 0, this.winW, this.winH);
			if (this.touchX > this.winW / 2 + this.scale * 156 / 2 - this.blockSize * 0.3 && this.touchX < this.winW / 2 + this.scale * 156 / 2 + this.blockSize * 0.3 && this.touchY > this.winH - this.scale * 63 && this.touchY < this.winH - this.scale * 63 + this.blockSize * 0.3)
				this.showTip = false;
			this.showTip && jsGame.canvas.drawImage("tip", 0, 0, 156, 63, this.winW / 2 - this.scale * 156 / 2, this.winH - this.scale * 63, this.scale * 156, this.scale * 63);
			if (this.pressButton == false) {
				//jsGame.canvas.drawImage("backBtn",
				//	0, 0, 180, 80, Math.round(this.blockSize * 0.3), this.backBtnY, Math.round(this.scale * 180), Math.round(this.scale * 80));
				jsGame.canvas.drawImage("startBtn", 0, 0, 167, 89, Math.round(this.blockSize * 7.4), this.startBtnY, Math.round(this.scale * 167), Math.round(this.scale * 89))
			} else if (this.btnTmpIndex == 1) {
			
				//if (this.buttonAnimateIndex == 3)
				  //dp_Ranking(); //打开排行榜
				  //window.location.href='http://resource.duopao.com/duopao/games/small_games/advplus/ad.htm';
				//history.length > 1 ? history.back() : window.location.reload(true);
				//jsGame.canvas.drawImage("btnAnimate", 164 * this.buttonAnimateIndex, 0, 164, 133, Math.round(this.blockSize * 0.3), this.backBtnY, Math.round(this.scale *
						//164), Math.round(this.scale * 133));
				//jsGame.canvas.drawImage("startBtn", 0, 0, 167, 89, Math.round(this.blockSize * 7.4), this.startBtnY, Math.round(this.scale * 167), Math.round(this.scale * 89))
			} else if (this.btnTmpIndex == 2) {
				if (this.buttonAnimateIndex == 3) {
					this.gameType = "help";
					this.initGameArgs()
				}
				//jsGame.canvas.drawImage("backBtn", 0, 0, 180, 80, Math.round(this.blockSize * 0.3), this.backBtnY, Math.round(this.scale * 180), Math.round(this.scale * 80));
				//jsGame.canvas.drawImage("btnAnimate", 164 * this.buttonAnimateIndex, 0, 164, 133, Math.round(this.blockSize *
						//7.4), this.startBtnY, Math.round(this.scale * 164), Math.round(this.scale * 133))
			}
			this.pressButton && this.welcomeIndex % 2 == 0 && this.buttonAnimateIndex++;
			if (this.touchBlockIndex > -1)
				if (this.touchX > Math.round(this.blockSize * 1.3) && this.touchX < Math.round(this.blockSize * 1.3) + Math.round(this.scale * 180) && this.touchY > this.backBtnY && this.touchY < this.backBtnY + Math.round(this.scale * 80)) {
					this.buttonAnimateIndex = 0;
					this.pressButton = true;
					this.btnTmpIndex = 1;
					this.touchBlockIndex = -1
				} else if (this.touchX > Math.round(this.blockSize *
						6.5) && this.touchX < Math.round(this.blockSize * 6.5) + Math.round(this.scale * 167) && this.touchY > this.startBtnY && this.touchY < this.startBtnY + Math.round(this.scale * 89)) {
					this.buttonAnimateIndex = 0;
					this.pressButton = true;
					this.btnTmpIndex = 2;
					this.touchBlockIndex = -1
				}
		} else if (this.gameType == "help") {
			this.initChoose();
			jsGame.canvas.drawImage("help", 67, 0 + this.iphoneCut / 2, 720, 450 - this.iphoneCut, 0, 0, this.winW, this.winH);
			if (this.touchBlockIndex > -1) {
				this.gameType = "choose";
				this.touchBlockIndex = -1
			}
		} else {
			if (this.gameType == "choose") {
				if (this.touchBlockIndex >
					-1) {
					this.level = -1;
					if (this.touchBlockIndex) {
						if (this.touchBlockIndex < 17 && this.touchBlockIndex > 9)
							this.level = this.touchBlockIndex - 9;
						else if (this.touchBlockIndex < 26 && this.touchBlockIndex > 18)
							this.level = this.touchBlockIndex - 11;
						else if (this.touchBlockIndex < 35 && this.touchBlockIndex > 27)
							this.level = this.touchBlockIndex - 13;
						var a = false;
						if (this.winLevels[this.level])
							a = true;
						if (a && 0 < this.level && this.level < 22) {
							this.pressButton = true;
							this.buttonAnimateIndex++;
							this.initLevelMap();
							this.touchBlockIndex = -1
						}
						if (this.touchBlockIndex ==
							36) {
							this.pressButton = true;
							this.buttonAnimateIndex++;
							this.touchBlockIndex = -1;
							this.btnTmpIndex = 1
						}
					}
				}
				this.ctx.drawImage(this.cacheChooseCanvas, 0, 0);
				this.pressButton && this.buttonAnimateIndex++;
				this.btnTmpIndex == 1 ? jsGame.canvas.drawImage("levelUpBtn", 54, 162, 54, 54, Math.round(this.blockSize * 0.15), Math.round(this.blockSize * 4.6), Math.round(this.scale * 54), Math.round(this.scale * 54)) : jsGame.canvas.drawImage("levelUpBtn", 0, 162, 54, 54, Math.round(this.blockSize * 0.15), Math.round(this.blockSize * 4.6), Math.round(this.scale *
						54), Math.round(this.scale * 54));
				if (this.buttonAnimateIndex >= 0 && this.buttonAnimateIndex <= 5)
					for (a = 0; a < 21; a++) {
						var d = (a % 7 + 1) * this.blockSize + this.left,
						c = (Math.floor(a / 7) + 1) * this.blockSize + this.top;
						if (this.winLevels[a + 1])
							a < 9 ? jsGame.canvas.drawNumber(a + 1, "number2", 23, 23, Math.round(d + this.blockSize * 0.23), Math.round(c + this.blockSize * 0.25), true, Math.round(this.scale * 20.7), Math.round(this.scale * 20.7)) : jsGame.canvas.drawNumber(a + 1, "number2", 23, 23, Math.round(d + this.blockSize * 0.1), Math.round(c + this.blockSize * 0.25),
								true, Math.round(this.scale * 20.7), Math.round(this.scale * 20.7));
						else
							jsGame.canvas.drawImage("lock", 0, 0, 27, 43, d + Math.round(this.blockSize * 0.25), Math.round(c + this.blockSize * 0.18), Math.round(this.scale * 21.6), Math.round(this.scale * 34.4));
						if (a == this.level - 1) {
							d = (a % 7 + 1) * this.blockSize + this.left;
							c = (Math.floor(a / 7) + 1) * this.blockSize + this.top;
							jsGame.canvas.drawImage("chooseBtn", 71, 0, 71, 71, d, c, Math.round(71 * this.scale * 0.8), Math.round(71 * this.scale * 0.8))
						}
					}
				if (this.buttonAnimateIndex == 4 && this.btnTmpIndex != 1) {
					this.gameType =
						"play";
					this.initGameArgs();
					this.pressButton = false
				} else if (this.buttonAnimateIndex == 4 && this.btnTmpIndex == 1) {
					this.gameType = "welcome";
					this.initGame();
					this.pressButton = false;
					this.score = 0;
					for (a = 1; a < 25; a++) {
						d = jsGame.localStorage.getItem(a + "_maxScore");
						if (d > 0)
							this.score += parseInt(d)
					}
				}
			}
			if (this.gameType == "play" || this.gameType == "fail" || this.gameType == "pause" || this.gameType == "win" || this.gameType == "levelUp")
				this.ctx.drawImage(this.cacheCanvas, 0, 0);
			if (this.gameType == "play") {
				this.playing = true;
				if (this.touchX > this.winW -
					this.scale * 60 && this.touchX < this.winW - 30 * this.scale && this.touchY < this.top && this.touchY > 0) {
					this.gameType = "pause";
					this.isRun = false
				}
				if (this.touchX > this.winW - this.left * 2 - Math.round(this.scale * 45) && this.touchX < this.winW - this.scale * 60 && this.touchY < this.top && this.touchY > 0) {
					if (this.bgMusicType == "play") {
						this.bgMusicPicY = 30;
						this.bgMusicType = "stop"
					} else if (this.bgMusicType == "stop") {
						this.bgMusicPicY = 60;
						this.bgMusicType = "play"
					}
					this.touchY = this.touchX = -1
				}
				jsGame.canvas.drawNumber(this.score, "number1", 17, 18, Math.round(this.blockSize *
						1.32), Math.round(this.blockSize * 0.11), true, Math.round(this.scale * 17), Math.round(this.scale * 18));
				jsGame.canvas.drawImage("ui1", 0, this.bgMusicPicY, 30, 30, this.winW - this.left * 2 - Math.round(this.scale * 45), 0, Math.round(30 * this.scale), Math.round(30 * this.scale));
				for (a = 0; a < 45; a++) {
					this.ctx.save();
					var b = this.levelMap[a];
					if (60 <= b.bid && b.bid <= 62 || 25 <= b.bid && b.bid <= 40 || b.hasTran) {
						d = (a + 9) % 9 * this.blockSize + this.left;
						c = Math.floor(a / 9) * this.blockSize + this.top;
						var e = 0,
						g = 0;
						if (60 <= b.bid && b.bid <= 62 || 25 <= b.bid && b.bid <=
							40) {
							e = d + this.halfBlockSize;
							g = c + this.halfBlockSize;
							if (this.touchBlockIndex == a && !this.isTranslate)
								this.isTranslate = this.readyTran = true;
							if (60 <= b.bid && b.bid <= 62) {
								this.tranType = 1;
								if (b.angle > 0) {
									var h = Math.PI * b.angle / 100,
									i = Math.cos(h);
									h = Math.sin(h);
									this.ctx.transform(i, h, -h, i, e * (1 - i) + g * h, g * (1 - i) - e * h)
								}
							} else
								this.tranType = 2
						}
						i = true;
						if (this.trains[0] && this.trains[0].trainInIndex == a)
							i = false;
						if (this.touchBlockIndex == a && this.readyTran && i)
							if (this.tranIndex == this.tranIndexMax)
								this.initTranBlock();
							else {
								if (this.tranType ==
									1) {
									if (this.tranIndex == 0)
										if (b.type1 == 2 && b.type2 < 4)
											b.type2 += 1;
										else if (b.type1 == 2 && b.type2 == 4)
											b.type2 = 1;
										else if (b.type1 == 1 && b.type2 == 1)
											b.type2 = 2;
										else if (b.type1 == 1 && b.type2 == 2)
											b.type2 = 1;
										else if (b.type1 == 2 && b.type2 == 5)
											b.type2 = 6;
										else if (b.type1 == 2 && b.type2 == 6)
											b.type2 = 5;
									this.tranIndex++;
									this.sc += this.delta;
									if (this.tranIndex == this.halfTranIndexMax)
										this.delta = -this.delta;
									b.angle += this.tranAngle;
									var j = 1 - this.sc;
									i = Math.cos(this.anglePi);
									h = Math.sin(this.anglePi);
									if (b.traning) {
										this.ctx.transform(this.sc, 0, 0,
											this.sc, e * j, g * j);
										this.ctx.transform(i, h, -h, i, e * (1 - i) + g * h, g * (1 - i) - e * h)
									}
								} else {
									this.tranIndex++;
									this.sc -= this.delta;
									if (this.tranIndex == this.halfTranIndexMax) {
										this.delta = -this.delta;
										this.levelMap[a] = new Blocks[b.tranTarget]
									}
									j = 1 - this.sc;
									b.traning && this.ctx.transform(this.sc, 0, 0, this.sc, e * j, g * j)
								}
								if (this.achieveThree != "hasUp" && this.trains[0])
									this.achieveThree = "true"
							}
						this.ctx.globalCompositeOperation = "source-over";
						b.bid == 60 || b.bid == 61 ? jsGame.canvas.drawImage("mapBlocks", b.x + 1, b.y + 1, Constant.blockSize - 1, Constant.blockSize -
							1, d, c, this.blockSize, this.blockSize) : jsGame.canvas.drawImage("mapBlocks", b.x, b.y, Constant.blockSize, Constant.blockSize, d, c, this.blockSize, this.blockSize);
						this.ctx.restore()
					}
				}
				a = parseInt(this.gameSecond / 60);
				jsGame.canvas.drawNumber(a, "number1", 17, 18, Math.round(5.55 * this.blockSize), Math.round(this.blockSize * 0.1), false, Math.round(this.scale * 17), Math.round(this.scale * 18));
				jsGame.canvas.drawImage("point", 0, 0, 6, 13, Math.round(5.6 * this.blockSize), Math.round(this.blockSize * 0.15), Math.round(this.scale * 9), Math.round(this.scale *
						13));
				a = parseInt(this.gameSecond % 60);
				jsGame.canvas.drawNumber(a, "number1", 17, 18, Math.round(5.75 * this.blockSize), Math.round(this.blockSize * 0.1), true, Math.round(this.scale * 17), Math.round(this.scale * 18))
			}
			if (this.gameType == "pause") {
				this.playing = false;
				this.ctx.save();
				this.ctx.globalCompositeOperation = "source-over";
				jsGame.canvas.drawImage("pause", 46, 0, 720, 450 - this.iphoneCut, 0, 0, this.winW, this.winH);
				if (this.touchBlockIndex == 22 || this.touchBlockIndex == 23 || this.touchBlockIndex == 31 || this.touchBlockIndex == 32)
					if (this.touchY <
						Math.round(this.blockSize * 2.3) + this.top + 31 * this.scale) {
						this.pressButton = true;
						this.buttonAnimateIndex++;
						jsGame.canvas.drawImage("ui2", 99, 62, 99, 33, Math.round(this.blockSize * 4.65) + this.left, Math.round(this.blockSize * 2.3) + this.top, 99 * this.scale, 31 * this.scale);
						jsGame.canvas.drawImage("ui2", 0, 95, 99, 29, Math.round(this.blockSize * 4.65) + this.left, Math.round(this.blockSize * 2.9) + this.top, 99 * this.scale, 29 * this.scale)
					} else {
						this.pressButton = true;
						this.buttonAnimateIndex++;
						jsGame.canvas.drawImage("ui2", 0, 62, 99, 33,
							Math.round(this.blockSize * 4.65) + this.left, Math.round(this.blockSize * 2.3) + this.top, 99 * this.scale, 31 * this.scale);
						jsGame.canvas.drawImage("ui2", 99, 95, 99, 29, Math.round(this.blockSize * 4.65) + this.left, Math.round(this.blockSize * 2.9) + this.top, 99 * this.scale, 29 * this.scale)
					}
				if (this.buttonAnimateIndex == 0) {
					jsGame.canvas.drawImage("ui2", 0, 62, 99, 33, Math.round(this.blockSize * 4.65) + this.left, Math.round(this.blockSize * 2.3) + this.top, 99 * this.scale, 31 * this.scale);
					jsGame.canvas.drawImage("ui2", 0, 95, 99, 29, Math.round(this.blockSize *
							4.65) + this.left, Math.round(this.blockSize * 2.9) + this.top, 99 * this.scale, 29 * this.scale)
				} else if (this.buttonAnimateIndex == 3)
					if (this.touchY < Math.round(this.blockSize * 2.3) + this.top + 31 * this.scale) {
						this.gameType = "play";
						this.isRun = this.trains[0] ? true : false;
						this.initGameArgs();
						this.pressButton = false
					} else if (this.touchY > Math.round(this.blockSize * 2.3) + this.top + 31 * this.scale) {
						this.gameType = "welcome";
						this.score = 0;
						for (a = 1; a < 25; a++) {
							d = jsGame.localStorage.getItem(a + "_maxScore");
							if (d > 0)
								this.score += parseInt(d)
						}
						this.initGame()
					}
				this.ctx.restore()
			}
			if (this.gameType ==
				"levelUp") {
				if (this.gameTypeHelpIndex == 0) {
					this.playing = false;
					a = [];
					a = this.levelUpScore[this.level];
					(d = jsGame.localStorage.getItem(this.level + "_maxScore")) && a.push(d);
					d = a.length;
					this.thisLevelScore = 1E3 - this.gameSecond * this.scoreScale;
					 
					//dp_submitScore(this.level,this.thisLevelScore);//上传提交分数 
					
					if (d > 1) {
						this.maxScore = this.getMaxValue(a);
						if (this.maxScore < this.thisLevelScore)
							this.isNew = true
					} else
						this.isNew = true;
					this.levelUpScore[this.level].push(this.thisLevelScore);
					this.winLevels[this.level + 1] = true;
					if (this.isNew) {
						this.levelUpScore[this.level][0] = this.thisLevelScore;
						jsGame.localStorage.setItem(this.level + "_maxScore", this.thisLevelScore)
					}
					a = jsGame.localStorage.getItem("maxLevel");
					if (!a || a < this.level + 1)
						jsGame.localStorage.setItem("maxLevel", this.level + 1)
				}
				this.gameTypeHelpIndex++;
				jsGame.canvas.drawImage("levelUp", 60, 0, 720, 450 - this.iphoneCut, 0, 0, this.winW, this.winH);
				this.maxScore && jsGame.canvas.drawNumber(this.maxScore, "number1", 17, 18, Math.round(this.blockSize * 6.2), Math.round(this.blockSize * 2.3), true, Math.round(this.scale * 20.4), Math.round(this.scale * 18 * 1.2));
				jsGame.canvas.drawNumber(this.thisLevelScore,
					"number1", 17, 18, Math.round(this.blockSize * 4.2), Math.round(this.blockSize * 2.97), true, Math.round(this.scale * 20.4), Math.round(this.scale * 18 * 1.2));
				this.isNew && jsGame.canvas.drawImage("newScore", 0, 0, 83, 83, Math.round(this.blockSize * 6), Math.round(this.blockSize * 3), Math.round(this.scale * 83), Math.round(this.scale * 83));
				jsGame.canvas.drawNumber(this.level, "number1", 17, 18, Math.round(4.4 * this.blockSize), Math.round(this.blockSize * 2), true, Math.round(this.scale * 20.4), Math.round(this.scale * 18 * 1.2));
				if (this.level <
					21) {
					jsGame.canvas.drawImage("levelUpBtn", 0, 0, 54, 54, Math.round(this.blockSize * 2.8), Math.round(this.blockSize * 3.6), Math.round(this.scale * 54), Math.round(this.scale * 54));
					jsGame.canvas.drawImage("levelUpBtn", 0, 54, 54, 54, Math.round(this.blockSize * 3.65), Math.round(this.blockSize * 3.6), Math.round(this.scale * 54), Math.round(this.scale * 54));
					jsGame.canvas.drawImage("levelUpBtn", 0, 108, 54, 54, Math.round(this.blockSize * 4.5), Math.round(this.blockSize * 3.6), Math.round(this.scale * 54), Math.round(this.scale * 54))
				}
				this.level ==
				21 && this.buttonAnimateIndex++;
				if (this.buttonAnimateIndex == 40)
					this.gameType = "win";
				if (this.touchBlockIndex > -1 && this.level < 21)
					if (this.touchX > Math.round(this.blockSize * 2.8) && this.touchX < Math.round(this.blockSize * 2.8) + Math.round(this.scale * 54) && this.touchY > Math.round(this.blockSize * 3.4) && this.touchY < Math.round(this.blockSize * 3.8) + Math.round(this.scale * 54)) {
						jsGame.canvas.drawImage("levelUpBtn", 54, 0, 54, 54, Math.round(this.blockSize * 2.8), Math.round(this.blockSize * 3.6), Math.round(this.scale * 54), Math.round(this.scale *
								54));
						this.btnTmpIndex = 1;
						this.pressButton = true;
						this.buttonAnimateIndex++
					} else if (this.touchX > Math.round(this.blockSize * 3.65) && this.touchX < Math.round(this.blockSize * 3.65) + Math.round(this.scale * 54) && this.touchY > Math.round(this.blockSize * 3.4) && this.touchY < Math.round(this.blockSize * 3.8) + Math.round(this.scale * 54)) {
						jsGame.canvas.drawImage("levelUpBtn", 54, 54, 54, 54, Math.round(this.blockSize * 3.65), Math.round(this.blockSize * 3.6), Math.round(this.scale * 54), Math.round(this.scale * 54));
						this.btnTmpIndex = 2;
						this.pressButton =
							true;
						this.buttonAnimateIndex++
					} else if (this.touchX > Math.round(this.blockSize * 4.5) && this.touchX < Math.round(this.blockSize * 4.5) + Math.round(this.scale * 54) && this.touchY > Math.round(this.blockSize * 3.4) && this.touchY < Math.round(this.blockSize * 3.8) + Math.round(this.scale * 54)) {
						jsGame.canvas.drawImage("levelUpBtn", 54, 108, 54, 54, Math.round(this.blockSize * 4.5), Math.round(this.blockSize * 3.6), Math.round(this.scale * 54), Math.round(this.scale * 54));
						this.btnTmpIndex = 3;
						this.pressButton = true;
						this.buttonAnimateIndex++
					}
				if (this.buttonAnimateIndex ==
					3 && this.pressButton) {
					this.hasBoss = false;
					if (this.btnTmpIndex == 1) {
						this.level = -1;
						this.gameType = "choose"
					} else if (this.btnTmpIndex == 2) {
						this.gameType = "play";
						this.initLevelMap()
					} else if (this.btnTmpIndex == 3) {
						this.gameType = "play";
						this.buttonAnimateIndex++;
						this.level++;
						this.initLevelMap()
					}
					this.trains = [];
					this.touchBlockIndex = -1;
					this.btnTmpIndex = 0;
					this.pressButton = false;
					this.gameTypeHelpIndex = this.buttonAnimateIndex = 0;
					this.isNew = false;
					this.gameSecond = this.maxScore = this.thisLevelScore = 0
				}
			}
			if (this.gameType == "win") {
				if (this.winIndex ==
					0) {
					this.score = 0;
					for (a = 1; a < 25; a++) {
						d = jsGame.localStorage.getItem(a + "_maxScore");
						if (d > 0)
							this.score += parseInt(d)
					}
				}
				c = this.winH - this.winIndex;
				if (c >= 0)
					this.winIndex += 6;
				else
					c = 0;
				if (c == 0 && this.touchBlockIndex > 0) {
					this.gameType = "welcome";
					this.initGame()
				}
				jsGame.canvas.drawImage("win", 67, 0 + this.iphoneCut, 720, 450 - this.iphoneCut, 0, c, this.winW, this.winH)
			}
			if (this.gameType == "fail") {
				this.playing = false;
				this.ctx.save();
				this.ctx.globalCompositeOperation = "source-over";
				jsGame.canvas.drawImage("fail", 46, 0, 720, 450 - this.iphoneCut,
					0, 0, this.winW, this.winH);
				if (this.touchBlockIndex == 30) {
					this.pressButton = true;
					this.buttonAnimateIndex++;
					jsGame.canvas.drawImage("ui2", 99, 0, 99, 32, Math.round(this.blockSize * 3 + this.left), Math.round(this.blockSize * 4.1), 99 * this.scale, 31 * this.scale);
					jsGame.canvas.drawImage("ui2", 0, 32, 99, 31, Math.round(this.blockSize * 5 + this.left), Math.round(this.blockSize * 4.1), 99 * this.scale, 31 * this.scale)
				} else if (this.touchBlockIndex == 32) {
					this.pressButton = true;
					this.buttonAnimateIndex++;
					jsGame.canvas.drawImage("ui2", 0, 0, 99,
						32, Math.round(this.blockSize * 3 + this.left), Math.round(this.blockSize * 4.1), 99 * this.scale, 31 * this.scale);
					jsGame.canvas.drawImage("ui2", 99, 32, 99, 31, Math.round(this.blockSize * 5 + this.left), Math.round(this.blockSize * 4.1), 99 * this.scale, 31 * this.scale)
				}
				if (this.buttonAnimateIndex == 0) {
					jsGame.canvas.drawImage("ui2", 0, 0, 99, 32, Math.round(this.blockSize * 3 + this.left), Math.round(this.blockSize * 4.1), 99 * this.scale, 31 * this.scale);
					jsGame.canvas.drawImage("ui2", 0, 32, 99, 31, Math.round(this.blockSize * 5 + this.left), Math.round(this.blockSize *
							4.1), 99 * this.scale, 31 * this.scale)
				} else if (this.buttonAnimateIndex == 3) {
					if (this.touchBlockIndex == 30) {
						this.trains = [];
						this.bossTrains = [];
						this.bossTrainInBlockIndex = -1;
						this.drawBossTrainIndex = 1;
						this.hasBoss = false;
						this.initLevelMap();
						this.playing = false;
						this.gameSecond = 0;
						this.gameType = "play"
					} else if (this.touchBlockIndex == 32) {
						this.initTranBlock();
						this.initGameArgs();
						this.trains = [];
						this.bossTrains = [];
						this.bossTrainInBlockIndex = -1;
						this.drawBossTrainIndex = 1;
						this.hasBoss = false;
						this.level = -1;
						this.playing = this.pressButton =
							false;
						this.gameSecond = 0;
						this.gameType = "choose"
					}
					this.initGameArgs()
				}
				this.ctx.restore()
			}
			if (this.gameType == "play") {
				if (this.hasBoss) {
					if (!this.bossTrains[0]) {
						d = 3;
						if (this.level == 5)
							d = 3;
						else if (this.level == 10)
							d = 7;
						if (this.level == 21)
							d = 4;
						for (a = 0; a < d; a++) {
							c = new Train(this.scale, this.blockSize, 4, 36);
							c.setSpeed(this.winH);
							c.tid = a + 1;
							c.initX = Math.floor(this.bossTrainInBlockIndex % 9 * this.blockSize) + this.left + this.halfBlockSize;
							c.initY = Math.floor(this.bossTrainInBlockIndex / 9) * this.blockSize + this.top + this.halfBlockSize;
							c.trainInIndex = this.bossTrainInBlockIndex;
							c.inBlock = this.levelMap[this.bossTrainInBlockIndex];
							c.outDirection = c.inBlock.type2;
							c.isBoss = true;
							if (c.outDirection == 1) {
								c.initX = c.initX - this.halfBlockSize + c.speed;
								c.angle = 100
							} else if (c.outDirection == 2) {
								c.initY = c.initY - this.halfBlockSize + c.speed;
								c.angle = 150
							} else if (c.outDirection == 3) {
								c.initX = c.initX + this.halfBlockSize - c.speed;
								c.angle = 0
							} else if (c.outDirection == 4) {
								c.initY = c.initY + this.halfBlockSize - c.speed;
								c.angle = 50
							}
							c.drawX = c.initX - c.halfW;
							c.drawY = c.initY - c.halfH;
							c.fromDirection = c.inBlock.type2 > 2 ? c.inBlock.type2 - 2 : c.inBlock.type2 + 2;
							this.bossTrains.push(c)
						}
						this.drawBossTrainIndex = 1
					}
					a = 0;
					for (d = this.bossTrains.length; a < d; a++)
						a == 1 && this.drawBossTrainIndex < this.bossTrains[a].startTrainSpaceTime1 + a || this.drawBossTrainIndex < this.bossTrains[a].startTrainSpaceTime1 + this.bossTrains[a].startTrainSpaceTime * (a - 1) + a || this.drawTrain(this.bossTrains[a]);
					this.drawBossTrainIndex && this.drawBossTrainIndex++
				}
				if (this.isRun || this.touchBlockIndex >= 0 && this.levelMap[this.touchBlockIndex] &&
					this.levelMap[this.touchBlockIndex].bid >= 44 && this.levelMap[this.touchBlockIndex].bid <= 47) {
					if (!this.isRun && !this.trains[0]) {
						this.isRun = true;
						for (a = 0; a < 4; a++) {
							c = new Train(this.scale, this.blockSize, 7);
							c.setSpeed(this.winH);
							c.tid = a + 1;
							c.initX = Math.floor(this.touchBlockIndex % 9 * this.blockSize) + this.left + this.halfBlockSize;
							c.initY = Math.floor(this.touchBlockIndex / 9) * this.blockSize + this.top + this.halfBlockSize;
							c.trainInIndex = this.touchBlockIndex;
							c.inBlock = this.levelMap[this.touchBlockIndex];
							c.outDirection = c.inBlock.type2;
							if (c.outDirection == 1) {
								c.initX = c.initX - this.halfBlockSize + c.speed;
								c.angle = 100
							} else if (c.outDirection == 2) {
								c.initY = c.initY - this.halfBlockSize + c.speed;
								c.angle = 150
							} else if (c.outDirection == 3) {
								c.initX = c.initX + this.halfBlockSize - c.speed;
								c.angle = 0
							} else if (c.outDirection == 4) {
								c.initY = c.initY + this.halfBlockSize - c.speed;
								c.angle = 50
							}
							c.drawX = c.initX - c.halfW;
							c.drawY = c.initY - c.halfH;
							c.fromDirection = c.inBlock.type2 > 2 ? c.inBlock.type2 - 2 : c.inBlock.type2 + 2;
							this.trains.push(c)
						}
						this.drawTrainIndex = 1
					}
					a = 0;
					for (d = this.trains.length; a <
						d; a++)
						a == 1 && this.drawTrainIndex < this.trains[a].startTrainSpaceTime1 + a || this.drawTrainIndex < this.trains[a].startTrainSpaceTime1 + this.trains[a].startTrainSpaceTime * (a - 1) + a || this.drawTrain(this.trains[a]);
					this.drawTrainIndex && this.drawTrainIndex++
				}
			}
		}
	};
	this.drawTrain = function (a) {
		if (this.isRun || this.hasBoss) {
			_trainInIndexNew = this.calcBlockIndex(a.initX, a.initY);
			if (_trainInIndexNew < 0 || _trainInIndexNew > 45 || a.initX <= this.left || a.initX >= this.winW - this.left || a.initY <= this.top || a.initY >= Math.round(this.top +
					this.blockSize * 5)) {
				this.gameType = "fail";
				this.isRun = false;
				a.trainInIndex = -1;
				this.initTranBlock();
				this.hasBoss = false
			} else if (_trainInIndexNew != a.trainInIndex) {
				a.inBlock = this.levelMap[_trainInIndexNew];
				if (a.inBlock.type1 == 4) {
				    
					this.gameType = "levelUp";
					this.initTranBlock();
					this.initGameArgs();
					this.isRun = false;
					
					return
				}
				a.fromDirection = a.getfromDirection(a.trainInIndex, _trainInIndexNew);
				var d = a.checkCanRunIn(a.fromDirection, a.inBlock.type1, a.inBlock.type2),
				c = true;
				a.isBoss || (c = !this.levelMap[_trainInIndexNew].hasBoss);
				if (d && c) {
					d = this.levelMap[_trainInIndexNew].getTranTargetFinal();
					if (a.isBoss)
						if (a.tid == 1 || a.tid == 3 || a.tid == 5 || a.tid == 7) {
							this.levelMap[a.trainInIndex].hasBoss = false;
							this.levelMap[_trainInIndexNew].hasBoss = true
						}
					if (d >= 0 && !a.isBoss) {
						this.levelMap[_trainInIndexNew] = new Blocks[d];
						this.levelMap[_trainInIndexNew].hasTran = true;
						a.inBlock = this.levelMap[_trainInIndexNew];
						this.levelMap[_trainInIndexNew].traning = false
					}
					a.trainInIndex = _trainInIndexNew;
					if (a.fromDirection == 1) {
						a.initX = Math.floor(_trainInIndexNew % 9 * this.blockSize) +
							this.left;
						a.initY = Math.floor(_trainInIndexNew / 9) * this.blockSize + this.top + this.halfBlockSize;
						a.drawX = a.initX - a.halfW;
						a.drawY = a.initY - a.halfH
					} else if (a.fromDirection == 3) {
						a.initX = Math.floor(_trainInIndexNew % 9 * this.blockSize) + this.left + 2 * this.halfBlockSize;
						a.initY = Math.floor(_trainInIndexNew / 9) * this.blockSize + this.top + this.halfBlockSize;
						a.drawX = a.initX - a.halfW;
						a.drawY = a.initY - a.halfH
					} else if (a.fromDirection == 2) {
						a.initX = Math.floor(_trainInIndexNew % 9 * this.blockSize) + this.left + this.halfBlockSize;
						a.initY =
							Math.floor(_trainInIndexNew / 9) * this.blockSize + this.top;
						a.drawX = a.initX - a.halfW;
						a.drawY = a.initY - a.halfH
					} else if (a.fromDirection == 4) {
						a.initX = Math.floor(_trainInIndexNew % 9 * this.blockSize) + this.left + this.halfBlockSize;
						a.initY = Math.floor(_trainInIndexNew / 9) * this.blockSize + this.top + 2 * this.halfBlockSize;
						a.drawX = a.initX - a.halfW;
						a.drawY = a.initY - a.halfH
					}
					d = a.angle % 50;
					c = parseInt(a.angle / 50);
					a.angle = c * 50 + d;
					if (d > 0)
						if (d < 25 && d > 0)
							a.angle = c * 50;
						else {
							if (d > 25 && d < 50)
								a.angle = (c + 1) * 50
						}
					else if (d < 0)
						if (d > -25 && d < 0)
							a.angle = c *
								50;
						else if (d < -25 && d > -50)
							a.angle = (c - 1) * 50;
					a.outDirection = a.getExitDirection(a.fromDirection, a.inBlock.type1, a.inBlock.type2);
					a.tranIndex = 1
				} else {
					this.isRun = false;
					a.trainInIndex = -1;
					this.gameType = "fail";
					this.initTranBlock()
				}
			}
		}
		if (this.isRun || this.hasBoss) {
			a.setTrainMoveXY();
			this.ctx.save();
			if (a.angle) {
				c = Math.PI * a.angle / 100;
				d = Math.cos(c);
				c = Math.sin(c);
				this.ctx.transform(d, c, -c, d, a.initX * (1 - d) + a.initY * c, a.initY * (1 - d) - a.initX * c)
			}
			c = d = 0;
			if (a.isBoss)
				if (a.tid == 1) {
					d = 56;
					c = 68
				} else {
					d = 0;
					c = 56
				}
			else if (a.tid == 1) {
				d = 112;
				c = 68
			} else if (a.tid == 2)
				c = d = 56;
			else if (a.tid == 3) {
				d = 0;
				c = 56
			} else if (a.tid == 4)
				c = d = 56;
			this.ctx.globalCompositeOperation = "source-over";
			a.drawIndex++;
			var b = "train";
			if (a.isBoss)
				b = "bossTrain";
			a.drawIndex > a.showIndex && this.levelMap[_trainInIndexNew].bid != 42 && this.levelMap[_trainInIndexNew].bid != 43 && jsGame.canvas.drawImage(b, d, 0, c, a.trainImgH, a.drawX, a.drawY, a.width, a.height);
			this.ctx.restore();
			if (a && a.tid == 1) {
				if (this.somkeIndex == 0 || this.somkeIndex % 4 == 0) {
					if (this.somkeLoopIndex >= 3)
						this.somkeLoopIndex = 0;
					this.smoke =
						Smoke[this.somkeLoopIndex];
					this.somkeLoopIndex++;
					if (this.somkeIndex == 0) {
						this.smokeDrawW = 1.3 * this.scale * this.smoke.width;
						this.smokeDrawH = 1.3 * this.scale * this.smoke.height
					}
				}
				this.somkeIndex++;
				this.ctx.save();
				if (a.angle) {
					c = Math.PI * a.angle / 100;
					d = Math.cos(c);
					c = Math.sin(c);
					this.ctx.transform(d, c, -c, d, a.initX * (1 - d) + a.initY * c, a.initY * (1 - d) - a.initX * c)
				}
				this.ctx.globalCompositeOperation = "source-over";
				a.drawIndex > a.showIndex && this.levelMap[_trainInIndexNew].bid != 42 && this.levelMap[_trainInIndexNew].bid != 43 && jsGame.canvas.drawImage("smoke",
					this.smoke.imgX, 0, this.smoke.width, this.smoke.height, a.drawX + 5, a.drawY + 2, this.smokeDrawW, this.smokeDrawH);
				this.ctx.restore()
			}
		}
	};
	this.calcBlockIndex = function (a, d) {
		var c = -1;
		if (a > this.left && a < this.winW - this.left && d > this.top && d < this.winH - this.top)
			c = this.blockSize < this.initblockSize ? Math.floor(a / this.blockSize) + Math.floor(d / this.blockSize) * 9 : Math.floor((a - this.left) / this.blockSize) + Math.floor((d - this.top) / this.blockSize) * 9;
		this.touchX = a;
		this.touchY = d;
		return c
	};
	this.updateBlockIndex = function (a) {
		this.touchBlockIndex =
			a
	};
	this.getMinValue = function (a) {
		for (var d = a[0], c = a.length, b = 1; b < c; b++)
			if (a[b] < d)
				d = a[b];
		return d
	};
	this.getMaxValue = function (a) {
		for (var d = a[1], c = a.length, b = 2; b < c; b++)
			if (a[b] > d)
				d = a[b];
		return d
	};
	this.initGame = function () {
		this.initTranBlock();
		this.initGameArgs();
		this.trains = [];
		this.bossTrains = [];
		this.bossTrainInBlockIndex = -1;
		this.drawBossTrainIndex = 1;
		this.hasBoss = false;
		this.level = -1;
		this.pressButton = false;
		this.winIndex = this.gameSecond = this.maxScore = this.thisLevelScore = 0;
		this.touchBlockIndex = -1;
		this.gameTypeHelpIndex =
			this.buttonAnimateIndex = this.btnTmpIndex = 0;
		this.isNew = false
	}
};
function main() {
	winH = winW = 0;
	scale = 1;
	isResize = portrait = false;
	jsGame.initImage([{
				id : "loading",
				src : "img/loading.png"
			}, {
				id : "tip",
				src : "img/tip.png"
			}, {
				id : "mapBlocks",
				src : "img/mapBlocks.png"
			}, {
				id : "fail",
				src : "img/fail.png"
			}, {
				id : "clue2",
				src : "img/clue2.png"
			}, {
				id : "smoke",
				src : "img/smoke.png"
			}, {
				id : "train",
				src : "img/train.png"
			}, {
				id : "ui1",
				src : "img/ui1.png"
			}, {
				id : "ui2",
				src : "img/ui2.png"
			}, {
				id : "pause",
				src : "img/pause.png"
			}, {
				id : "number1",
				src : "img/number1.png"
			}, {
				id : "number2",
				src : "img/number2.png"
			}, {
				id : "chooseBtn",
				src : "img/chooseBtn.png"
			}, {
				id : "choose",
				src : "img/choose.png"
			}, {
				id : "lock",
				src : "img/lock.png"
			}, {
				id : "win",
				src : "img/win.png"
			}, {
				id : "bg",
				src : "img/bg.png"
			}, {
				id : "help",
				src : "img/help.png"
			}, {
				id : "levelUp",
				src : "img/levelUp.png"
			}, {
				id : "levelUpBtn",
				src : "img/levelUpBtn.png"
			}, {
				id : "point",
				src : "img/point.png"
			}, {
				id : "newScore",
				src : "img/newScore.png"
			}, {
				id : "welcome",
				src : "img/welcome.png"
			}, {
				id : "backBtn",
				src : "img/backBtn.png"
			}, {
				id : "startBtn",
				src : "img/startBtn.png"
			}, {
				id : "btnAnimate",
				src : "img/btnAnimate.png"
			}, {
				id : "bossTrain",
				src : "img/bossTrain.png"
			}
		]).setRunFrequency(50);
	initCanvas = function () {
		jsGame.canvas.screen.setHeight(800);
		var f = window.innerWidth,
		a = window.innerHeight,
		d = 1;
		if (window.innerWidth > window.innerHeight) {
			if (jsGame.canvas.screen.getTouch())
				if (a == 208)
					a = 268;
			if (f < 720 || a < 450)
				if (a == 268) {
					d = 268 / 402;
					f = Math.floor(Constant.gameW * d)
				} else if (f >= Math.round(Constant.WHScale * a)) {
					d = a / Constant.gameH;
					f = Math.round(Constant.gameW * d)
				} else {
					d = f / Constant.gameW;
					a = Math.round(Constant.gameH * d)
				}
			else {
				f = 720;
				a = 450
			}
			portrait = false
		} else
			portrait = true;
		if (f != winW || a != winH) {
			scale = d;
			winW = f;
			winH = a;
			isResize = true;
			jsGame.canvas.screen.setWidth(f);
			jsGame.canvas.screen.setHeight(a);
			portrait || window.scrollTo(0, 1)
		}
	};
	initCanvas();
	jsGame.initImageCallBack(function (f, a) {
		if (f >= a)
			jsGame.gameFlow.run();
		else
			try {
				var d = f / a;
				d = d > 1 ? 1 : d;
				var c = jsGame.canvas.getContext();
				c.fillStyle = "#FFFFFF";
				c.fillRect(0, 0, window.innerWidth, window.innerHeight);
				c.drawImage(jsGame.getImage("loading"), 0, 0, 250, 81, Math.round((winW - 250 * scale) / 2), Math.round((winH - 81 * scale) / 2), Math.round(250 * scale), Math.round(81 * scale));
				c.drawImage(jsGame.getImage("loading"),
					2, 86, 246 * d, 10, Math.round((winW - 246 * scale) / 2), Math.round(winH * 0.525), 246 * d * scale, 10 * scale)
			} catch (b) {}

	});
	jsGame.pageLoad(function (f) {
		var a = new RM;
		a.init(winW, winH, scale);
		if (winW > winH) {
			document.body.style.backgroundColor = "#302315";
			a.screenOk = true
		} else {
			document.body.style.backgroundColor = "white";
			a.screenOk = false
		}
		isResize = false;
		jsGame.touch.touchStart(function () {
			if (!(a.isTranslate || a.pressButton)) {
				var d = jsGame.touch.getStartPos();
				d = a.calcBlockIndex(d.x, d.y);
				a.updateBlockIndex(d)
			}
		});
		f.touch.touchEnd(function () {
			a.bgMusicType ==
			"play" ? bgMusic.pause() : bgMusic.play()
		});
		jsGame.run(function () {
			initCanvas();
			if (isResize) {
				a.init(winW, winH, scale);
				if (winW > winH) {
					document.body.style.backgroundColor = "#302315";
					a.screenOk = true
				} else {
					document.body.style.backgroundColor = "white";
					a.screenOk = false
				}
				isResize = false
			}
			if (portrait) {
				jsGame.canvas.clearScreen();
				a.ctx.drawImage(f.getImage("clue2"), (window.innerWidth - 122) / 2, (window.innerHeight - 145) / 2)
			} else {
				window.scrollTo(0, 1);
				a.drawGame()
			}
		})
	})
}
var leaderboards = function (f) {
	jsGame.ajax({
		type : "get",
		dataType : "html",
		url : "http://sina.duopao.com/sinainterface.do?interface=leaderboards/set&source=2752658403&session_key=" + jsGame.request.get("wyx_session_key") + "&rank_id=1&value=" + f + "&platform_id=2",
		before : function () {},
		success : function (a) {
			console.log(a)
		},
		error : function () {},
		complete : function () {
			isSend = false
		}
	})
}, achievements = function (f) {
	jsGame.ajax({
		type : "get",
		dataType : "html",
		url : "http://sina.duopao.com/sinainterface.do?interface=achievements/set&source=2752658403&session_key=" +
		jsGame.request.get("wyx_session_key") + "&achv_id=" + f + "&platform_id=2",
		before : function () {},
		success : function (a) {
			console.log(a)
		},
		error : function () {},
		complete : function () {
			isSend = false
		}
	})
};
